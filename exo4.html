<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>WegGL : exo 4</title>
</head>
<body>
    <canvas id="glCanvas" width="800" height="600"></canvas>

    <script id="vertexShader" type="x-shader/x-vertex">
        attribute vec3 location;
        uniform mat3 scaleMatrix;
        uniform mat3 transformMatrix;
        uniform mat3 viewMatrix;

        void main()
        {
           vec3 locationInView = viewMatrix * transformMatrix * scaleMatrix * location;
           gl_Position = vec4(locationInView, 1);
        }
    </script>

    <script id ="fragmentShader" type="x-shader/x-fragment">
        precision mediump float;

        const vec3 color = vec3(.8,.3,.6);

        void main()
        {
            gl_FragColor = vec4(color, 1.0);
        }
    </script>

    <script type="text/javascript">
        const canvas = document.getElementById("glCanvas");
        const gl = canvas.getContext("webgl");

        const vertexShader = gl.createShader(gl.VERTEX_SHADER);
        gl.shaderSource(vertexShader, document.getElementById("vertexShader").text);
        gl.compileShader(vertexShader);
        if (! gl.getShaderParameter(vertexShader, gl.COMPILE_STATUS)) {
            throw "Vertex shader error: " + gl.getShaderInfoLog(vertexShader);
        }

        const fragmentShader = gl.createShader(gl.FRAGMENT_SHADER);
        gl.shaderSource(fragmentShader, document.getElementById("fragmentShader").text);
        gl.compileShader(fragmentShader);
        if (! gl.getShaderParameter(fragmentShader, gl.COMPILE_STATUS)) {
            throw "Fragment shader error: " + gl.getShaderInfoLog(fragmentShader);
        }

        const shaderProgram = gl.createProgram();
        gl.attachShader(shaderProgram, vertexShader);
        gl.attachShader(shaderProgram, fragmentShader);
        gl.linkProgram(shaderProgram);
        if (! gl.getProgramParameter(shaderProgram, gl.LINK_STATUS)) {
            throw "Shader program error: " + gl.getProgramInfoLog(shaderProgram);
        }
        gl.useProgram(shaderProgram);
        const uniformTimePosition = gl.getUniformLocation(shaderProgram, "time");
        const uniformColorPosition = gl.getUniformLocation(shaderProgram, "color");
        const uniformViewMatrixPosition = gl.getUniformLocation(shaderProgram, "viewMatrix");
        const uniformScaleMatrixPosition = gl.getUniformLocation(shaderProgram, "scaleMatrix");
        const uniformTransformMatrixPosition = gl.getUniformLocation(shaderProgram, "transformMatrix");
        gl.bindAttribLocation(shaderProgram, 0, 'location');
        gl.enableVertexAttribArray(0);

        const viewMatrix = [
            1, 0, 0,
            0, canvas.width / canvas.height, 0,
            0, 0, 1
        ]

        gl.uniformMatrix3fv(uniformViewMatrixPosition, false, viewMatrix);

        const vertices = [
            -1,  1, 1,
            -1, -1, 1,
             1,  1, 1,
            -1, -1, 1,
             1, -1, 1,
             1,  1, 1,
        ];

        const verticesBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, verticesBuffer);
        gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertices), gl.STATIC_DRAW);

        const scaleMatrix = [
            .1, 0, 0,
            0, .1, 0,
            0, 0,  1
        ]

        gl.uniformMatrix3fv(uniformScaleMatrixPosition, false, scaleMatrix);
        
        const transformMatrix = [
            1, 0, 0,
            0, 1, 0,
            0, 0, 1
        ]

        gl.uniformMatrix3fv(uniformTransformMatrixPosition, false, transformMatrix);

        const startTime = new Date().getTime();
        const fps = 1000 / 25;

        function draw() {
            requestAnimationFrame(draw);

            const elapsedTime = new Date().getTime() - startTime;
            if (elapsedTime > fps) {
                transformMatrix[6] = (elapsedTime / 1000) % 2 - 1;
                gl.uniformMatrix3fv(uniformTransformMatrixPosition, false, transformMatrix);
                gl.bindBuffer(gl.ARRAY_BUFFER, verticesBuffer);
                gl.vertexAttribPointer(0, 3, gl.FLOAT, false, 0, 0);
                gl.drawArrays(gl.TRIANGLES, 0, vertices.length / 3);
            }
        }

        window.addEventListener("load", draw);
    </script>

</body>
</html>
